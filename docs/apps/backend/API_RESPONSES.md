# API Responses & Enveloping

This document outlines the standard API response format (envelope) used across the `apps/backend` project. 

## 1. Goal

The goal of the API envelope is to provide predictability for front-end clients. Clients need to know exactly how to parse successes and failures without guessing based on the HTTP status code or route.

## 2. Universal Shape

Every REST endpoint must return JSON that adheres to the `ApiResponse<T>` envelope defined in `modules/shared/types/ApiResponse.ts`.

It has two flavors: **Success** and **Error**. Both flavors share standard top-level properties:

- `ok`: Boolean indicating success.
- `traceId`: A unique string UUID for request tracing.
- `data` OR `error`: Mutually exclusive payload.

## 3. Success Responses

When returning data successfully (e.g., HTTP 200, 201), the route should use the `createApiResponse()` helper.

```json
{
  "ok": true,
  "traceId": "9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d",
  "data": {
    "userId": "123",
    "name": "Jane"
  }
}
```

### Usage in Route Handlers

Use the `createApiResponse` helper from `modules/shared/infrastructure/utils/api-response.ts`:

```typescript
import { createApiResponse } from '@/modules/shared/infrastructure/utils/api-response.ts';

app.get('/users/:id', async (c) => {
  const user = await db.getUser(c.req.param('id'));
  
  // The helper automatically infers the traceId from the Hono Context 'ctx' variable.
  return c.json(createApiResponse(c, user));
});
```

*Note: You do not need to manually attach the `traceId`; the helper extracts it from `c.get('ctx').traceId`.*

## 4. Error Responses

If a request fails, the system returns an error envelope. **You almost never construct this manually.** It is automatically generated by the `globalErrorHandler` when an error is thrown (see `ERROR_HANDLING.md`).

```json
{
  "ok": false,
  "traceId": "9b1deb4d-3b7d-4bad-9bdd-2b0d7b3dcb6d",
  "error": {
    "code": "UNPROCESSABLE_ENTITY",
    "message": "Business validation failed",
    "details": {
      "reason": "Insufficient balance"
    }
  }
}
```

## 5. Type Safety

The typescript definition enforces this contract strictly:

```typescript
export type ApiSuccessResponse<T> = {
  ok: true;
  traceId: string;
  data: T;
};

export type ApiErrorResponse = {
  ok: false;
  traceId: string;
  error: {
    code: string;
    message: string;
    details?: unknown;
  };
};

export type ApiResponse<T> = ApiSuccessResponse<T> | ApiErrorResponse;
```
When consuming this on the frontend, checking `if (response.ok)` serves as a typescript type-guard, safely narrowing the object to either contain `.data` or `.error`.
